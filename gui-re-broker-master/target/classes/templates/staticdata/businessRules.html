<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<th:block th:replace="fragments/import :: info-header"/>
	<th:block th:replace="fragments/import :: css-header"/>
	<th:block th:replace="fragments/import :: js-header"/>
</head>

<body id="page-top">
	<th:block th:replace="fragments/general :: navbar-header"/>
	
  	<div id="wrapper">
		<th:block th:replace="fragments/general :: menu"/>
		
    	<div id="content-wrapper">
      		<div class="container-fluid">
      		<th:block th:replace="fragments/general :: panel-page"/>

				<!-- CONTENT PAGE -->
				<div class="card mb-3">
	          	 <div class="card-header">
	              	<b><span id="titlePage" th:text="${titlePage}"></span></b>
	             </div>
	             
	             <!-- INQUIRY -->
		         <div id="businessRulesIndexPage" class="card-body">     
				  	<div class="row card-body justify-content-end">
						<button id="btnCreate" class="btn btn-primary col-md-2" onclick="create()">
							<i class="fa fa-plus"></i> Create
						</button>
					</div>
					
					<br>
					
					<div class="row justify-content-end">
						<div class="input-group col-md-2 ">
							<input id="brFilterValue" name="filterValue" type="text"
								class="form-control">
							<div class="input-group-append">
								<button id = btn_brFilterValue class="btn btn-primary" type="button">
									<i class="fas fa-search"></i>
								</button>
							</div>
						</div>
					</div>
					
					<br>
					
		            <table
					  id="tableBusinessRules"
					  data-toggle="table"
					  data-sortable="true"
					  data-url=""
					  data-side-pagination="server"
					  data-pagination="true"
					  data-page-size="5"
					  data-page-list="[5, 10, 25, 50, ALL]">
					  <thead>
					    <tr>
					      <th data-field="brCode" data-sortable="true">Code</th>
					      <th data-field="brParentDesc">Description</th>
					      <th data-field="brCurrId">Currency</th>
					      <th data-field="brDataStatusDesc">Status</th>
					    </tr>
					  </thead>
					</table>
		         </div>
		         
	         	 <div id="businessRulesCreateEdit" class="card-body" hidden="true">
	         	 	<div id="alertSuccess" class="alert alert-success" style="display: none;">
				   		<strong>Success!</strong> <span id="alertSuccessMsg" th:text="${M_0005}"></span>
					</div>
					<div id="alertFailed" class="alert alert-danger" style="display: none;">
				   		<strong>Failed!</strong> <span id="alertFailedMsg"></span>
					</div>
			    	
			    	<input type="hidden" id="h_isCreate"/>
	
					<form id="formInputBusinessRules" class="form-horizontal">
					  	
					  	<!-- Button Back -->
					  	<div class="row justify-content-end">
							<div class="col-md-2">
								<button class="btn btn-danger col-md-12" onclick="back()">
									<i class="fa fa-chevron-left"></i> Back
								</button>
							</div>
						</div>
						<br>
						
						<!-- Row 1 input -->
						<div class="row">
							<div class="col-md-2">
								<label>*Code</label> <br> <input type="text"
									name="code" id="brCode" class="form-control col-md-12"
									/>
									<input type="hidden" id="h_brCode"/>
									<input type="hidden" id="h_idKey"/>
							</div>
							<div class="col-md-4">
								<label>*Description</label> <br> <input type="text"
									name="description" id="brDescription" class="form-control col-md-12"
									/>
									<input type="hidden" id="h_brDescription"/>
							</div>
							<div class="col-md-2">
								<label>*Currency</label> <br> <select name="currency" id="brCurrency"
									class="select2" style="width:100%">
								</select>
								<input type="hidden" id="h_brCurrency"/>
							</div>
							<div class="col-md-2">
								<label>*Status</label> <br> 
								<select id="brStatus" class="select2" style="width:100%">
				      			</select>
				      			<input type="hidden" id="h_brStatus"/>
							</div>
						</div>
						
						<br>
						
						<!-- Row 2 Input -->
						<div id="cart" class="card mb-3">
							<div class="card-body">
								<div class="row">
									<div class="col-md-3">
										<label>*Chart of Account</label> <br>
										<div class="input-group">
											<input id="brCoa" name="coa" type="text" class="form-control"
												disabled>
											<input type="hidden" id="h_brCoaDesc">
											<div class="input-group-append">
												<button id='btnCoaSearch' class="btn btn-primary"
													type="button" data-toggle="modal" data-target="#modalLookupCoa">
													<i class="fas fa-search"></i>
												</button>
											</div>
										</div>
									</div>
									<div class="col-md-2">
										<label>*Position</label> <br> <select name="position" id="brPosition"
											class="form-control col-md-12">
											<option value='0'>Debit</option>
											<option value='1'>Credit</option>
										</select>
										<input type="hidden" id="h_brPosition"/>
									</div>
									<div class="col-md-4">
										<label>*Value</label> <br> <select name="value" id="brValue"
											class="select2" style="width:100%">
										</select>
										<input type="hidden" id="h_brValue"/>
									</div>
									<div class="col-md-1">
									<label><font color = "white">Add</font></label>
									<br>
										<button id="btnAdd" class="btn btn-success col-md-12" onclick="add()">Add</button>
									</div>
								</div>
								
								<br>
								
								<table
								  id="tableBusinessRulesAdd"
								  data-toggle="table"
								  data-sortable="true"
								  data-unique-id="id">
								  <thead>
								    <tr>
								      <th data-field="brChildCoa" data-sortable="true">COA</th>
								      <th data-field="brCoaDescript">Description</th>
								      <th data-field="brChildDcDesc">Position</th>
								      <th data-field="brChildValue">Value</th>
								      <th data-field="brChildValue">Value</th>
									  <th data-field="action" data-halign="center" data-align="center">Action</th>
								    </tr>
								  </thead>
								</table>
							</div>
						</div>
					</form>
					<th:block th:replace="fragments/button :: btn-save-cancel"/>
				 </div>
				</div>
        

      		</div>
      		<!-- /.container-fluid -->
			<th:block th:replace="fragments/general :: copyright-footer"></th:block>
    	</div>
    	<!-- /.content-wrapper -->
	</div>
  	<!-- /#wrapper -->
	<th:block th:replace="fragments/modal :: confirmation-save" />
	<th:block th:replace="fragments/general :: scroll-to-top"/>
	<th:block th:replace="fragments/general :: logout-modal"/>
	<th:block th:replace="fragments/import :: js-body"/>

	<!-- Modal COA -->
	<div class="modal fade" id="modalLookupCoa" tabindex="-1" role="dialog" 
			aria-labelledby="modalLookupCoa" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modalLookupCoaLabel">Chart Of Account</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">					
					<div class="row card-body justify-content-end">
						<div class="col-md-3">
							<select id="filterKeyCoa" name="filterKeyCoa" class="custom-select col-md-2">
									<option value="coaCode">Account</option>
									<option value="coaDescript">Description</option>
							</select>
						</div>
						<div class="input-group col-md-3">
							<input type="text" class="form-control" id="filterValueCoa">
							<div class="input-group-append">
								<button class="btn btn-primary" id="btnfilterValueCoa" type="button">
									<i class="fas fa-search"></i>
								</button>
							</div>
						</div>
					</div>

					<table
					  id="tableCoa"
					  data-toggle="table"
					  data-sortable="true"
					  data-url=""
					  data-pagination="true"
					  data-side-pagination="server"
					  data-page-size="5"
					  data-page-list="[5, 10, 25, 50, ALL]">
					  <thead>
					    <tr>
					      <th data-field="coaCode" data-sortable="true">Account</th>
					      <th data-field="coaDescript" data-sortable="true">Description</th>
					    </tr>
					  </thead>
					</table>
				</div>
			</div>
		</div>
	</div>
</body>

<script type="text/javascript" th:inline="javascript">
/*<![CDATA[*/
$('document').ready(function() {
	$('#filterKeyCoa').select2({ width: '100%' });
	
	/**
	 * Drop down Currency 
	 */
	/* $.ajax({
	    url: "/gui-re-broker/static-data/exchangeRate/dropdownCurr"
	}).then(function(data) {
		
		$('#brCurrency').select2({
		  width: '100%',
		  data:(JSON.parse(data)).results
		});
	}); */
	
	/**
	 * Button Save on GUI action 
	 */
	/* $('#btnSave').click(function() {
		$('#btnSave').attr('disabled', true);
		$('#modalConfirmation').modal('show');
	}); */
	
	/**
	 * Button Cancel on GUI action 
	 */
	$('#btnCancel').click(function() {
		reset();
	});
	
	/**
	 * Modal Confirmation - YES 
	 */
	 $('#btnModalYes').click(function() {
		$('#btnModalYes').attr('disabled', 'true');
		$('#modalConfirmation').modal('hide');
		save();
	 });
	
	 /**
		 * Button Search 
		 */
		$('#btn_brFilterValue').click(function() {
			inquiry();
		});
	
	/**
	 * Inquiry Table 
	 */
	 inquiry();
	
  	/**
	 * Dropdown Status Initialize 
	 */
	function initializeDropdown() {
		return $.ajax({
			type: 'GET', global: false, dataType: 'json',
			url: /*[[@{/static-data/dropdown-status}]]*/
		});
	}
	initializeDropdown().done(function(data) {
		$('#brStatus').select2({data: data});
	});
	
	/**
	 * Dropdown Currency Initialize 
	 */
	function initDropdownCurrency() {
		return $.ajax({
			type: 'GET', global: false, dataType: 'json',
			url: /*[[@{/static-data/dropdown-currency}]]*/
		});
	}
	initDropdownCurrency().done(function(data) {
		$('#brCurrency').select2({width: '100%', data: data});
	});
	
	$('#brPosition').select2({ width: '100%' });
	
	/**
	 * Dropdown Value Initialize 
	 */
	function initDropdownValue() {
		return $.ajax({
			type: 'GET', global: false, dataType: 'json',
			url: /*[[@{/static-data/dropdown-value}]]*/
		});
	}
	
	initDropdownValue().done(function(data) {
		$('#brValue').select2({width: '100%', data: data});
	});
	
	/**
	 * COA Search 
	 */
	$('#btnCoaSearch').click(function() {
		$("#filterKeyCoa").val('coaCode');
		$("#filterValueCoa").val('');
		searchCoa();
	});
	$('#btnfilterValueCoa').click(function() {
		searchCoa();
	});
	
	$('#tableCoa').on('click-row.bs.table', function(e, row, $tr) {
  		$('#brCoa').val(row.coaCode);
  		$('#h_brCoaDesc').val(row.coaDescript);
  		$('#btnAdd').removeAttr('disabled');
  		$('#modalLookupCoa').modal('hide');
  	});
});    

function inquiry(){
	var url = /*[[@{/static-data/businessRules/inquiry}]]*/;
	url = url + '?filterValue=' + $('#brFilterValue').val();
	/**
	 * Inquiry Table 
	 */
  	$('#tableBusinessRules').bootstrapTable('refreshOptions', {
  		theadClasses: 'thead-dark',
        url: url
    });
}

function inquiryChild(brCode) {
	var url = /*[[@{/static-data/businessRules/inquiryChild}]]*/;
	url = url + '?brCode=' + brCode;
	
	$.ajax({ 
        type: "GET",
        dataType: "json",
        url: url,
    }).then(function(resultObject) {
    	var rows = [];
    	
    	for(var i=0;i<resultObject.rows.length;i++) {
	    	var id = create_UUID();
	    	var action = "<button class=\"btn btn-danger\" onclick=\"removeAdd('"+id+"')\">" 
	    	+ "<i class=\"fa fa-trash\"></i>" 
	    	+ "</button>";
	    	
	    	rows.push({
	    		id: id,
	    		brChildCoa: resultObject.rows[i].brChildCoa,
	    		brChildDc: resultObject.rows[i].brChildDc,
	    		brChildValue: resultObject.rows[i].brChildValue,
	    		brCoaDescript: resultObject.rows[i].brCoaDescript,
	    		brChildDcDesc: resultObject.rows[i].brChildDcDesc,
	    		action: action
	        });
    	}
    	
    	$('#tableBusinessRulesAdd').bootstrapTable('load', rows);
    });
}

function create(){
	$('#titlePage').text(/*[[${titlePageCreate}]]*/);
	$('#businessRulesCreateEdit').removeAttr('hidden');
	$('#businessRulesIndexPage').attr('hidden', true);
	$('#btnAdd').attr('disabled', 'true');
}

function back(){
	$('#titlePage').text(/*[[${titlePage}]]*/);
	$('#businessRulesCreateEdit').attr('hidden', true);
	$('#businessRulesIndexPage').removeAttr('hidden');
}

function searchCoa(){
	var filterKey = $("#filterKeyCoa").val();
	var filterValue = $( "#filterValueCoa" ).val();
	var urlInq = /*[[@{/static-data/beginBal/lookup-coa}]]*/;
	
	urlInq = urlInq + "?filterKey=" + filterKey + "&filterValue=" + filterValue;
	$('#tableCoa').bootstrapTable('refreshOptions', {
  		paginationSuccessivelySize: 3,
        theadClasses: 'thead-dark',
        url: urlInq
    });
}

function add() {
	var p_Coa = $('#brCoa').val();
	var p_Position = $('#brPosition option:selected').val();
	var p_PositionDesc = $('#brPosition option:selected').text();
	var p_Value = $('#brValue').val();
	var p_Desc = $('#h_brCoaDesc').val();
	
	var rows = $('#tableBusinessRulesAdd').bootstrapTable('getData');
	var id = create_UUID();
	var action = "<button class=\"btn btn-danger\" onclick=\"removeAdd('"+id+"')\">" 
	+ "<i class=\"fa fa-trash\"></i>" 
	+ "</button>";
	
	rows.push({
		id:id,
		brChildCoa:p_Coa,
		brChildDc:p_Position,
		brChildValue: p_Value,
		brCoaDescript: p_Desc,
		brChildDcDesc: p_PositionDesc,
		action: action
    });
	
	$('#btnAdd').attr('disabled', 'true');
	$('#tableBusinessRulesAdd').bootstrapTable('load', rows);
	
	$('#brCoa').val("");
	$('#brPosition').val($('#brPosition option:first-child').val()).trigger('change');
	$('#brValue').val($('#brValue option:first-child').val()).trigger('change');
	$('#h_brCoaDesc').val("");
}

function removeAdd(id) {
	$('#tableBusinessRulesAdd').bootstrapTable('removeByUniqueId', id);
	
	var rows = $('#tableBusinessRulesAdd').bootstrapTable('getData');	
	$('#tableBusinessRulesAdd').bootstrapTable('load', rows);
}

function create_UUID() {
    var dt = new Date().getTime();
    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = (dt + Math.random()*16)%16 | 0;
        dt = Math.floor(dt/16);
        return (c=='x' ? r :(r&0x3|0x8)).toString(16);
    });
    
    return uuid;
}

$('#btnSave').click(function() {
	var msgRequaired = /*[[${M_0008}]]*/;
	
	var val = validationRequired();
	msgRequaired = msgRequaired + ": " + val + ".";

	var rows = $('#tableBusinessRulesAdd').bootstrapTable('getData');
	
	if(val.length>0) {
		showAlertFailed(msgRequaired);
	}else if(rows.length==0) {
		showAlertFailed("Table can't empty.");
	}else {
		$('#btnSave').attr('disabled', true);
		$('#btnModalYes').removeAttr('disabled');
		$('#modalConfirmation').modal('show');
	}
});



function validationRequired() {		
	var field = [];
	
	var code = $('#brCode').val();
	if(!code.trim())
		field.push("Code");
	
	var desc = $('#brDescription').val();
	if(!desc.trim())
		field.push("Description");
	
	var curr = $('#brCurrency').val();
	if(!curr.trim())
		field.push("Currency");
	
	var status = $('#brStatus').val();
	if(!status.trim())
		field.push("Status");
	
	return field;
}

function showAlertFailed(msgAlert) {
	$(location).attr('href','#page-top');
	$('#alertFailedMsg').text(msgAlert);
	$('#alertFailed').fadeTo(3000, 500).slideUp(500, function() {
	    $('#alertFailed').slideUp(500);
	});
}

function save() {
	var p_Code = $('#brCode').val();
	var p_Description = $('#brDescription').val();
	var p_Currency = $('#brCurrency').val();
	var p_Status = $('#brStatus').val();
	var p_idKey = $('#h_idKey').val();
	
	var rows = $('#tableBusinessRulesAdd').bootstrapTable('getData');
	
	var rowsData = [];
	for(var i = 0;i<rows.length;i++) {
		rowsData.push(rows[i]);
	}
	
	var datas = {
			brCode: p_Code,
			brParentDesc: p_Description,
			brParentGroup: p_Currency,
			brDataStatus: p_Status,
			brIdKey : p_idKey,
			rows: rowsData
	}
	
	$.ajax({
		type: 'POST', 
		global: false, 
		dataType: 'json',  
		contentType:'application/json',
		url: /*[[@{/static-data/businessRules/save}]]*/, 
		data: JSON.stringify(datas), 
		complete:function(jqXHR, textStatus){
 			if(textStatus == "success") {
 				showAlertSuccess();
 				reset();
 			}else {
 				showAlertFailed(/*[[${M_0006}]]*/);
 				$('#btnSave').removeAttr('disabled');
 			} 
        }
	}); 
	
	$('#btnModalyes').removeAttr('disabled');
 	$('#modalConfirmation').modal('hide');
}

function reset(){
	$('#brCode').val($('#h_brCode').val());
	$('#brDescription').val($('#h_brDescription').val());
	$('#brCurrency').select2().val($('#h_brCurrency').val()).trigger('change');
	$('#brStatus').select2().val($('#h_brStatus').val()).trigger('change');
	$('#brCoa').val();
	$('#brPosition').select2().val($('#h_brPosition').val()).trigger('change');
	$('#brValue').select2().val($('#h_brValue').val()).trigger('change');
	
	var rows = [];
	$('#tableBusinessRulesAdd').bootstrapTable('load', rows);
	
	$('#btnSave').removeAttr('disabled');
}

function showAlertSuccess() {
	$(location).attr('href','#page-top');
	$('#alertSuccess').fadeTo(2000, 500).slideUp(500, function() {
	    $('#alertSuccess').slideUp(500);
	});	
}

//Data table event on click-row
$('#tableBusinessRules').on('click-row.bs.table',function(e, row, $tr) {
	$('#titlePage').text(/*[[${titlePageEdit}]]*/);
	$('#businessRulesCreateEdit').removeAttr('hidden');
	$('#businessRulesIndexPage').attr('hidden', true);
	$('#btnAdd').attr('disabled', 'true');
	var brCode = row.brCode;
	
	$('#brCode').val(row.brCode);
	$('#brDescription').val(row.brParentDesc);
	$('#brCurrency').select2().val(row.brCurrId).trigger('change');
	$('#brStatus').select2().val(row.brDataStatus).trigger('change');
	$('#h_idKey').val(row.idKey);
	
	inquiryChild(brCode);
	
	
});

/*]]>*/
</script>    
       
</html>