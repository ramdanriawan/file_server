<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
<th:block th:replace="fragments/import :: info-header" />
<th:block th:replace="fragments/import :: css-header" />
<th:block th:replace="fragments/import :: js-header" />

<script th:src="@{/js/autoNumeric.min.js}"></script>
</head>

<body id="page-top">
	<th:block th:replace="fragments/general :: navbar-header" />

	<div id="wrapper">
		<th:block th:replace="fragments/general :: menu" />

		<div id="content-wrapper">
			<div class="container-fluid">
				<th:block th:replace="fragments/general :: panel-page" />

				<!-- CONTENT PAGE -->
				<div id="cart" class="card mb-3">
					<div id="divContentHeader" class="card-header">
						<b><span id="titlePage" th:text="${titlePage}"></span></b>
					</div>
					<div class="card-body">
						<div id="alertSuccess" class="alert alert-success"
							style="display: none;">
							<strong>Success!</strong> <span id="alertSuccessMsg"
								th:text="${M_0005}"></span>
						</div>
						<div id="alertFailed" class="alert alert-danger"
							style="display: none;">
							<strong>Failed!</strong> <span id="alertFailedMsg"></span>
						</div>
						
						<div id="adjustmentForm">
							<div class="row">
								<div class="col-md-4">
									<label>*Client/Cedant</label> <br>
									<div class="input-group">
										<input id="clientDesc" name="clientDesc" type="text"
											class="form-control" disabled> 
										<input id="client" name="client" type="text" 
											class="form-control" hidden="true" disabled/>
				
										<div class="input-group-append">
											<button id='btnClientSearch' class="btn btn-primary"
												type="button" data-toggle="modal"
												data-target="#client-modal">
												<i class="fas fa-search"></i>
											</button>
										</div>
									</div>
								</div>
							</div>
							
							<br>
							
							<div class="row">
								<div class="col-md-4">
									<div class="row">
										<div class="col-md-12">
											<label>*Insured Period</label>
										</div>
									</div>
									<div class="row">
										<div class="col-md-5">
											<div class="input-group">
												<input id="insuredPeriod" name="insuredPeriod"
													type="text" class="form-control" disabled>
												<div class="input-group-append">
													<button id='btnInsuredPeriod' class="btn btn-primary" type="button">
														<i class="fas fa-calendar"></i>
													</button>
												</div>
											</div>
										</div>
										<div class="col-md-2">
											<div class="row justify-content-center">
												<label> - </label>
											</div>
										</div>
										<div class="col-md-5">
											<div class="input-group">
												<input id="insuredPeriodTo" name="insuredPeriodTo"
													type="text" class="form-control" disabled>
												<div class="input-group-append">
													<button id='btnInsuredPeriodTo' class="btn btn-primary"
														type="button">
														<i class="fas fa-calendar"></i>
													</button>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							
							<br>
							<br>
							
							<th:block th:replace="fragments/button :: btn-search-reset" />
							
							<br>
							<br>
							
							<table id="tableAdjustment" data-toolbar-align="right"
								data-toggle="table" data-sortable="true" data-url=""
								data-side-pagination="server" data-pagination="true"
								data-page-size="5" data-page-list="[5, 10, 25, 50, ALL]"
								data-pagination-V-Align="top">
								<thead>
									<tr>
										<th data-field="requestId" data-sortable="true">Request ID</th>
										<th data-field="client" data-sortable="true">Client</th>
										<th data-field="period">Period</th>
										<th data-field="curr">Curr</th>
										<th data-field="treAdjAmountFmt" data-halign="right" data-align="right">Amount</th>
										<th data-field="treAdjStatus">Status</th>
										<th data-field="action" data-halign="center" data-align="center">Action</th>
									</tr>
								</thead>
							</table>
						</div>
						
						<div id="adjustmentEditForm" hidden="true">
							<div class="row justify-content-end">
								<div class="col-md-2">
									<button id="btnBack" class="btn btn-danger col-md-12">
										<i class="fa fa-chevron-left"></i> Back
									</button>
								</div>
							</div>
							
							<div class="card-body">
								<div class="row">
									<div class="col-md-2">Request Id</div>
									RQ -
									<div class="col-md-2">
										<input type="text" name="requestId" id="requestId"
											class="form-control" disabled />
									</div>
								</div>
								
								<br>
							
								<div class="card mb-3">
									<div class="card-body">
									<input type="hidden" id="adjStatus"/>
									<div class="row">
										<div class="col-md-12">
											<table id="interestTable" data-toggle="table" data-unique-id="idKey">
												<thead>
													<tr>
														<th data-field="idKey" data-visible="false">Id Key</th>
														<th data-field="trxCobGroup" data-visible="false">Group Id</th>
														<th data-field="trxCobGroupDesc">Group</th>
														<th data-field="trxLayer">Layer</th>
														<th data-field="trxCoverCodeDesc">Class Of Business</th>
														<th data-field="trxOgnrpiFmt" data-halign="right" data-align="right">Est. OGNRPI</th>
														<th data-field="trxOgnrpiActFmt" data-halign="right" data-align="right">Actual</th>
														<th data-field="action" data-halign="center" data-align="center">Action</th>
													</tr>
												</thead>
											</table>
										</div>
									</div>
									
									<br>
									
									<div class="row">
										<input type="hidden" id="idKey"/>
										<div class="col-md-4">
											<label>Class Of Business</label><br> 
											<input type="text" name="cob" id="cob" class="form-control" disabled/>
										</div>
										<div class="col-sm-3">
											<label>Est. OGNRPI</label><br> 
											<input type="text" name="estOgnrpi" id="estOgnrpi" 
												class="form-control" style="text-align: right;" required disabled/>
										</div>
										<div class="col-sm-3">
											<label>Actual</label><br> 
											<input type="text" name="estOgnrpiAct" id="estOgnrpiAct" 
												class="form-control" style="text-align: right;" required />
										</div>
										<div class="col-md-2">
											<label>&nbsp;</label><br>
											<button id="btnUpdate" class="btn btn-success col-md-12"
												onclick="updateSave()" disabled>Update</button>
										</div>
									</div>
									
								</div>
									
							</div>
							
							<div id="buttonSave">
								<th:block th:replace="fragments/button :: btn-save-validate" />
							</div>
							<div id="buttonSave2" hidden="true">
								<th:block th:replace="fragments/button :: btn-save" />
							</div>
						</div>
						
						<br>
						
						<div id="previewReport" class="card-body" hidden="true">							
							<table id="tableReport" data-toolbar-align="right"
								data-toggle="table" data-pagination="true" data-page-size="10">
								<thead>
									<tr>
										<th data-field="action" data-halign="center" data-align="center">Action</th>
										<th data-field="group">Group</th>
										<th data-field="layer">Layer/QS</th>
										<th data-field="name">Name</th>
										<th data-field="document">Document</th>
									</tr>
								</thead>
							</table>
							
							<div id="previewReportHtml"></div>
						</div>
												
					</div>
				</div>

			</div>
			
			<!-- /.container-fluid -->
			<th:block th:replace="fragments/general :: copyright-footer"></th:block>
		</div>
		<!-- /.content-wrapper -->
	</div>
	<!-- /#wrapper -->

	<th:block th:replace="fragments/general :: scroll-to-top" />
	<th:block th:replace="fragments/general :: logout-modal" />
	<th:block th:replace="fragments/import :: js-body" />
</body>

	<!-- Modal Client -->
	<div class="modal fade" id="client-modal" tabindex="-1"
		role="dialog" aria-labelledby="client-modal" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="client-modal-label">Client</h5>
					<button id="btnCloseClientModal" type="button" class="close" 
						data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div class="row card-body justify-content-end">
						<div class="col-md-3">
							<select id="clientSelector" name="clientSelector"
								class="custom-select">
								<option value="cliName">Name</option>
								<option value="cliCode">Client Id</option>
							</select>
						</div>
						<div class="input-group col-md-3">
							<input id="clientFilterValue" type="text" class="form-control">
							<div class="input-group-append">
								<button id="clientFilterSearchBtn" class="btn btn-primary"
									type="button" onclick="clientFilteredSearch()">
									<i class="fas fa-search"></i>
								</button>
							</div>
						</div>
					</div>
					
					<table id="tableClient" data-toggle="table" data-url=""
						data-sortable="true" data-side-pagination="server"
						data-pagination="true" data-page-size="5"
						data-page-list="[5, 10, 25, 50, ALL]"
						data-pagination-V-Align="top">
						<thead>
							<tr>
								<th data-field="cliCode" data-sortable="true">Client ID</th>
								<th data-field="cliName" data-sortable="true">Client Name</th>
								<th data-field="cliTypeDesc">Type</th>
								<th data-field="cliDataStatusStr">Status</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
	</div>
	<!-- /Modal Client -->

<script type="text/javascript" th:inline="javascript">
	/*<![CDATA[*/
		
	const formatter_2 = new Intl.NumberFormat('en-US', {
		style: 'currency',
		currency: 'USD',
		minimumFractionDigits: 2
	});
		
	$(function() {
		$('#clientSelector').select2({ width: '100%' });
		
		$('#btnSearch').click();
		disableButton();
	});
	
	$('#insuredPeriod').datepicker({
		dateFormat: 'dd/mm/yy',
		changeMonth: true,
		changeYear: true
	});
	$('#insuredPeriodTo').datepicker({
		dateFormat: 'dd/mm/yy',
		changeMonth: true,
		changeYear: true
	});
	
	new AutoNumeric('#estOgnrpi', {
	    decimalCharacter : '.',
	    digitGroupSeparator : ',',
	    maximumValue : '999999999999999999.00',
	    minimumValue : '0'
	});
	AutoNumeric.getAutoNumericElement('#estOgnrpi').set('0.00');
	
	new AutoNumeric('#estOgnrpiAct', {
	    decimalCharacter : '.',
	    digitGroupSeparator : ',',
	    maximumValue : '999999999999999999.00',
	    minimumValue : '0'
	});
	AutoNumeric.getAutoNumericElement('#estOgnrpiAct').set('0.00');
	
	$('#btnInsuredPeriod').click(function(){
		$('#insuredPeriod').datepicker('show');
	});
	$('#btnInsuredPeriodTo').click(function(){
		$('#insuredPeriodTo').datepicker('show');
	});
	$('#insuredPeriod').change(function() {		
		$('#insuredPeriodTo').datepicker('option', 'minDate', $('#insuredPeriod').val());
	});
	$('#reinsuredPeriod').change(function() {		
		$('#reinsuredPeriodTo').datepicker('option', 'minDate', $('#reinsuredPeriod').val());
	});
	
	$('#tableClient').on('click-row.bs.table',function(e, row, $tr) {
		$('#client').val(row.cliCode);
		$('#clientDesc').val(row.cliName);
		$('#client-modal').modal('hide');
	});
	
	$('#btnCloseClientModal').click(function() {
		$('#client').val('');
		$('#clientDesc').val('');
	});
	
	$('#btnClientSearch').click(function() {			
		$('#clientFilterValue').val('');
		$('#clientSelector').val('cliName').trigger('change');
		
		var url = /*[[@{/static-data/client}]]*/;
		url = url + "?cliType=1";
		$('#tableClient').bootstrapTable('refreshOptions', {
		    theadClasses: 'thead-dark',
		    url: url
		});
	});
	
	function clientFilteredSearch() {
		var url = /*[[@{/static-data/client}]]*/;
		var filterKey = $("#clientSelector").select2('val');
		var filterValue = $("#clientFilterValue").val();
		
		url = url + "?cliType=1";
		if(filterValue != "")
			url = url + "&filterKey="+filterKey+"&filterValue="+filterValue;
		
		$('#tableClient').bootstrapTable('refreshOptions', {
		    theadClasses: 'thead-dark',
		    url: url
		});
	}
	
	$('#btnReset').click(function() {
		$('#client').val('');
		$('#clientDesc').val('');
		$('#insuredPeriod').datepicker('setDate', null);
		$('#insuredPeriodTo').datepicker('setDate', null);
		
		$('#tableAdjustment').bootstrapTable('removeAll');
	});
	
	$('#btnBack').click(function() {
		location.reload();
	});
	
	$('#btnSearch').click(function() {
		var urlInq = /*[[@{/marketing/treaty-adjustment/inquiry}]]*/;
		urlInq += '?client=' + $('#clientDesc').val() + '&treInsStart=' + $('#insuredPeriod').val() + '&treInsEnd=' + $('#insuredPeriodTo').val();
		
		$('#tableAdjustment').bootstrapTable('refreshOptions', {
	  		paginationSuccessivelySize: 3,
	        theadClasses: 'thead-dark',
	        url: urlInq
	    });
	});
	
	function edit(trxVoucherId, status) {
		var param = {
			trxVoucherId: trxVoucherId
		}
			
		$.ajax({ 
	        type: 'POST',
	        dataType: 'json',
	        contentType: 'application/json',
	        data: JSON.stringify(param),
	        url: /*[[@{/marketing/treaty-adjustment/inquiryModify}]]*/,
	    }).then(function(result) {    	    	
		    $('#titlePage').text(/*[[${titlePageCreate}]]*/);
			$('#adjustmentEditForm').removeAttr('hidden');
			$('#adjustmentForm').attr('hidden', true);
			
			$('#interestTable').bootstrapTable('load', result);
			
			$('#requestId').val(trxVoucherId);
			$('#adjStatus').val(status);
			
			enableButton();
			
			$('#idKey').val('');
	    });	
	}
	
	function cancel(trxVoucherId) {
		var param = {
			trxVoucherId: trxVoucherId
		}
		
		var isCancel = confirm("Are you sure to cancel ?");
		if(isCancel == true) {
			$.ajax({
				type: 'POST', global: false, dataType: 'json',  
				contentType:'application/json',
				url: /*[[@{/marketing/treaty-adjustment/cancel}]]*/, 
				data: JSON.stringify(param), 
				success: function (data) {
				}
			}).done(function(data) {
				location.reload();
			}).fail(function() {
				showAlertFailed('Failed Cancel Adjustment!');
			});
		}
	}
	
	function update(idKey) {
		var interest = $('#interestTable').bootstrapTable('getRowByUniqueId', idKey);
		
		$('#idKey').val(interest.idKey);
		$('#cob').val(interest.trxCoverCodeDesc);
		AutoNumeric.getAutoNumericElement('#estOgnrpi').set(interest.trxOgnrpi);
		AutoNumeric.getAutoNumericElement('#estOgnrpiAct').set(interest.trxOgnrpiAct);
		
		$('#btnUpdate').removeAttr('disabled');
	}
	
	function updateSave() {
		var idKey = $('#idKey').val();
		var interest = $('#interestTable').bootstrapTable('getRowByUniqueId', idKey);
		
		interest.trxOgnrpiAct = AutoNumeric.getAutoNumericElement('#estOgnrpiAct').get();
		interest.trxOgnrpiActFmt = formatter_2.format(interest.trxOgnrpiAct).replace('$', '');
		$('#interestTable').bootstrapTable('updateByUniqueId', interest);
		
		$('#idKey').val('');
		$('#cob').val('');
		AutoNumeric.getAutoNumericElement('#estOgnrpi').set(0.00);
		AutoNumeric.getAutoNumericElement('#estOgnrpiAct').set(0.00);
		
		$('#btnUpdate').attr('disabled', 'true');
	}
	
	$('#btnSave').click(function() {
		doSave(false);
	});
	
	$('#btnValidate').click(function() {
		doSave(true);
	});
	
	function doSave(isProcess) {
		disableButton();
		
		save().done(function(data) {
			if(isProcess)
				doAdjustment();
			else {
				showAlertSuccess();
				enableButton();	
			}
		}).fail(function() {
			showAlertFailed(/*[[${M_0006}]]*/);
			enableButton();
		});
	}
	
	function save() {
		var trxVoucherId = $('#requestId').val();
		var interest = $('#interestTable').bootstrapTable('getData');
		
		var param = {
			trxVoucherId: trxVoucherId,
			interest: interest
		}
		
		return $.ajax({type: 'POST', global: false, dataType: 'json',  
			contentType: 'application/json',
			url: /*[[@{/marketing/treaty-adjustment/save}]]*/, 
			data: JSON.stringify(param), 
			success: function (data) {
			}
		});
	}
	
	function doAdjustment() {		
		var trxVoucherId = $('#requestId').val();
		var param = {
			"trxVoucherId": trxVoucherId
		};
			
		$.ajax({
			type: 'POST', global: false, dataType: 'json',  
			contentType:'application/json',
			url: /*[[@{/marketing/treaty-adjustment/process}]]*/, 
			data: JSON.stringify(param), 
			success: function (data) {
			}
		}).done(function(data) {
			data.sort(compareTableReport);
			
			showAlertSuccess();
			$('#tableReport').bootstrapTable('load', data);
			$('#previewReport').removeAttr('hidden');
		}).fail(function() {
			showAlertFailed('Cannot Adjustment');
			enableButton();
		});
	}
	
	function printPreviewClosing(voucherId, group, layer, clientCode, clientName, type) {		
		var trxVoucherId = $('#requestId').val();
		var url = /*[[@{/marketing/treaty-adjustment/print}]]*/;
		var param = '?voucherId=' + voucherId 
				+ '&type=' + type 
				+ '&trxVoucherId=' + trxVoucherId
				+ '&code=' + clientCode
				+ '&group=' + group
				+ '&layer=' + layer;
		
		param = encodeURI(param);
		
		window.open(url+param, '_blank');
	}
	
	function exportPreviewClosing(voucherId, group, layer, clientCode, clientName, file, type) {	
		var trxVoucherId = $('#requestId').val();
		var url = /*[[@{/marketing/treaty-adjustment/document}]]*/;
		var param = '?voucherId=' + voucherId  
				+ '&type=' + type
				+ '&trxVoucherId=' + trxVoucherId
				+ '&code=' + clientCode
				+ '&group=' + group
				+ '&layer=' + layer 
				+ '&fileName=' + file;
		
		param = encodeURI(param);
		
		window.open(url+param, '_blank');
	}
	
	function disableButton() {
		$('#btnSave').attr('disabled', 'true');
		$('#btnValidate').attr('disabled', 'true');
	}
	
	function enableButton() {
	    $('#btnSave').removeAttr('disabled');
	    
	    if($('#adjStatus').val() === 'New')
	   		$('#btnValidate').removeAttr('disabled');
	}
	
	function showAlertFailed(msgAlert) {
		$(location).attr('href','#page-top');
		$('#alertFailedMsg').text(msgAlert);
		$('#alertFailed').fadeTo(3000, 500).slideUp(500, function() {
		    $('#alertFailed').slideUp(500);
		});
	}
	
	function showAlertSuccess(msgAlert) {
		$(location).attr('href','#page-top');
		$('#alertSuccessMsg').text(msgAlert);
		$('#alertSuccess').fadeTo(2000, 500).slideUp(500, function() {
		    $('#alertSuccess').slideUp(500);
		});	
	}
	
	function compareTableReport(a, b) {
		  const group1 = a.group.toUpperCase();
		  const group2 = b.group.toUpperCase();

		  if(group1 > group2)
		    return 1;
		  else if (group1 < group2)
		    return -1;
		  
		  const layer1 = a.layer.toUpperCase();
		  const layer2 = b.layer.toUpperCase();
		  
		  if(layer1 > layer2)
			return 1;
		  else if (layer1 < layer2)
		    return -1;
		  
		  const document1 = a.document.toUpperCase();
		  const document2 = b.document.toUpperCase();
		  
		  if(document1 > document2)
			return -1;
		  else if (document1 < document2)
		    return 1;
		  
		  return 0;
	}
		
	/*]]>*/
</script>

</html>