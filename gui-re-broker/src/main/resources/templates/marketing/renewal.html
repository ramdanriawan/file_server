<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
<th:block th:replace="fragments/import :: info-header" />
<th:block th:replace="fragments/import :: css-header" />
<th:block th:replace="fragments/import :: js-header" />
</head>

<body id="page-top">
	<th:block th:replace="fragments/general :: navbar-header" />

	<div id="wrapper">
		<th:block th:replace="fragments/general :: menu" />

		<div id="content-wrapper">
			<div class="container-fluid">
				<th:block th:replace="fragments/general :: panel-page" />

				<!-- CONTENT PAGE -->
				<div id="cart" class="card mb-3">

					<div id="loadingModal" class="modal" tabindex="-1" role="dialog">
						<div class="modal-dialog" role="document">
							<div class="modal-content">
								<div class="d-flex align-items-center">
									<strong>Loading...</strong>
									<div class="spinner-border ml-auto" role="status"
										aria-hidden="true"></div>
								</div>
							</div>
						</div>
					</div>

					<div id="divContentHeader" class="card-header">
						<b><span id="titlePage" th:text="${titlePage}"></span></b>
					</div>
					<div id="alertSuccess" class="alert alert-success"
						style="display: none;">
						<strong>Success!</strong> <span id="alertSuccessMsg"
							th:text="${M_0005}"></span>
					</div>
					<div id="alertSuccessDelete" class="alert alert-success"
						style="display: none;">
						<strong>Success!</strong> <span id="alertSuccessDeleteMsg">Delete
							data success</span>
					</div>
					<div id="alertSuccessSend" class="alert alert-success"
						style="display: none;">
						<strong>Success!</strong> <span id="alertSuccessDeleteMsg">Renewal Sended!</span>
					</div>
					
					<div id="alertFailed" class="alert alert-danger"
						style="display: none;">
						<strong>Failed!</strong> <span id="alertFailedMsg"></span>
					</div>

					<div class="card-body">
						<div id="alertSuccess" class="alert alert-success"
							style="display: none;">
							<strong>Success!</strong> <span id="alertSuccessMsg"
								th:text="${M_0005}"></span>
						</div>
						<div id="alertFailed" class="alert alert-danger"
							style="display: none;">
							<strong>Failed!</strong> <span id="alertFailedMsg"></span>
						</div>

						<div id="index">
							<div class="row">
								<div class="col-md-2">
									<label>Type of Cover</label>
								</div>
								<div class="col-md-3">
									<select name="typeOfCover" id="typeOfCover"
										class="form-control" required>
										<option value="ALL">ALL</option>
									</select>
								</div>
							</div>
							<br>
							<div class="row">
								<div class="col-md-2">
									<label>Client</label>
								</div>
								<div class="col-md-3">
									<th:block th:replace="fragments/lookup :: client-2" />
								</div>
							</div>
							<br>
							<div class="row">
								<div class="col-md-2">
									<label>Expiry Date</label>
								</div>
								<div class="col-md-2">
									<div class="input-group">
										<input id="expiryDate" name="expiryDate" type="text"
											class="form-control" disabled>
										<div class="input-group-append">
											<button id='btnExpiryDate' class="btn btn-primary"
												type="button">
												<i class="fas fa-calendar"></i>
											</button>
										</div>
									</div>
								</div>
								<div class="col-md-1">
									<label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to</label>
								</div>
								<div class="col-md-2">
									<div class="input-group">
										<input id="to" name="to" type="text" class="form-control"
											disabled>
										<div class="input-group-append">
											<button id='btnTo' class="btn btn-primary" type="button">
												<i class="fas fa-calendar"></i>
											</button>
										</div>
									</div>
								</div>
							</div>
							<br>
							<div class="row">
								<div class="col-md-2">
									<label>Status</label>
								</div>
								<div class="col-md-2">
									<select name="type" id="status" class="form-control col-md-12">
										<option value="ALL">ALL</option>
										<option value="0">Renewable</option>
										<option value="1">Non Renewable</option>
									</select>
								</div>
							</div>
							<br>
							<th:block th:replace="fragments/button :: btn-search-reset" />

						</div>
						<div id="result">
							<br>
							<div class="row justify-content-end">
								<button id="btnExportToExcle" class="btn btn-success col-md-1" disabled>
									Export</button>
								&nbsp;&nbsp;&nbsp;&nbsp;
								<button id="btnPrint" class="btn btn-secondary col-md-1" disabled>
									Print</button>
							</div>
							<br>
							<table id="tableRenewal" data-toggle="table" data-sortable="true"
								data-url="" data-side-pagination="server" data-pagination="true"
								data-page-size="5" data-pagination-v-align="top"
								data-unique-id="idKey" data-page-list="[5, 10, 25, 50, ALL]">
								<thead>
									<tr>
										<th data-field="idKey" data-sortable="true">idKey</th>
										<th data-field="trxInsEndStr" data-sortable="true">Expiry
											Date</th>
										<th data-field="trxInsEnd" data-sortable="true">trxInsEnd</th>
										<th data-field="trxVoucherId" data-sortable="true">Voucher</th>
										<th data-field="trxClassDesc" data-sortable="true">Type</th>
										<th data-field="cliName">Client</th>
										<th data-field="trxCoverCode" data-sortable="true">Product</th>
										<th data-field="trxDescription" data-sortable="true">Description</th>
										<th data-field="trxInsRemarks" data-sortable="true">Policy
											No</th>
										<th data-field="underwrite" data-sortable="true">Underwriter</th>
										<th data-field="trxCurrId" data-sortable="true">Curr</th>
										<th data-field="trxSumInsured" data-sortable="true"
											data-halign="right" data-align="right">TSI</th>
										<th data-field="trxPremiumSell" data-sortable="true"
											data-halign="right" data-align="right">Premum</th>
										<th data-field="action" data-sortable="true">Action</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>

				</div>
				<!-- /.container-fluid -->
				<th:block th:replace="fragments/general :: copyright-footer"></th:block>
				<th:block th:replace="fragments/modal :: confirmation-delete"></th:block>
			</div>
			<!-- /.content-wrapper -->
		</div>


		<!-- /#wrapper -->
		<th:block th:replace="fragments/modal :: confirmation-save-v2" />
		<th:block th:replace="fragments/general :: scroll-to-top" />
		<th:block th:replace="fragments/general :: logout-modal" />
		<th:block th:replace="fragments/import :: js-body" />
</body>

<script type="text/javascript" th:inline="javascript">
	/*<![CDATA[*/
		
	$(function() {
		
		$('#clientDesc').val('ALL');
		$('#status').select2({
			width : '100%'
		});
		$('#tableRenewal').bootstrapTable('hideColumn', 'idKey');
		$('#tableRenewal').bootstrapTable('hideColumn', 'trxInsEnd');
				rest('GET', [[${urlTypeOfCover}]] )
					.done(function(data) {
						$('#typeOfCover').select2({
							width : '100%',
							data : data
						});
					});
				$('#expiryDate').datepicker({
					dateFormat: 'dd/mm/yy',
					changeMonth: true,
					changeYear: true,
				}).datepicker('setDate', [[${appDate}]]);
				
				$('#to').datepicker({
					dateFormat: 'dd/mm/yy',
					changeMonth: true,
					changeYear: true,
					minDate:[[${appDate}]]
				}).datepicker('setDate', [[${appDate}]]);
							
				$('#btnExpiryDate').click(function() {
					$('#expiryDate').datepicker('show');
				});
				$('#btnTo').click(function() {
					$('#to').datepicker('show');
				});
				
				$('#expiryDate').change(function() {
					$('#to').datepicker('option','minDate', $('#expiryDate').val());
				});
				$('#clientDesc').change(function() {
					if($('#clientDesc').val() == ''){
						$('#clientDesc').val('ALL');
					}
				});
				
				$('#btnSearch').click(function() {
					search('/gui-re-broker/marketing/renewal/inquiry');
				});
				
				$('#btnExportToExcle').click(function() {
					exportTable();
				});
				$('#btnPrint').click(function() {
					print();
				});
				
				$('#tableRenewal').bootstrapTable('refreshOptions', {
				    theadClasses: 'thead-dark',
				});
				$('#tableRenewal').on('load-success.bs.table', function () {
					var data = $('#tableRenewal').bootstrapTable('getData');
					if(data.length > 0){
						$('#btnExportToExcle').removeAttr('disabled');
						$('#btnPrint').removeAttr('disabled');
					}else{
						$('#btnExportToExcle').attr('disabled', true);
						$('#btnPrint').attr('disabled', true);
						
					}
				})
				
				$('#btnReset').click(function() {
					location.reload();
				});
				
				$('#btnModalYesDelete').click(function(){
					$('#btnModalYesDelete').attr('disabled', 'true');
					processRemove(idRemove);					
				});
			});
	
	function search(url){
				var typeOfCover = $('#typeOfCover').val();
				var expiryDate = $('#expiryDate').val();
				var to = $('#to').val();
				var client = $('#clientDesc').val();
				var status = $('#status').val();
				url = url + '?typeOfCover=' + typeOfCover
						+ '&expiryDate=' +expiryDate
						+ '&to=' +to
						+ '&client=' +client
						+ '&status=' +status
				$('#tableRenewal').bootstrapTable('refreshOptions', {
				    theadClasses: 'thead-dark',
				    url: url,
				    pageNumber: 1
				});
				
	}
	
	var idRemove = null;
	function remove(idKey){
		idRemove = idKey;
		$('#modalConfirmationDelete').modal('show');
	}
	
	
	function edit(idKey){
		
		$('#loadingModal').modal('show');
		var dataEdit = {
				idKey : idKey
		}
		restPOST('POST', '/gui-re-broker/marketing/renewal/edit', dataEdit).done(function(data) {
			
			setTimeout(function () {
		       	console.log('completed');
		       	$('#loadingModal').modal('hide');
		    }, 0);
			if (data.status == "200") {
				showAlertSuccess();
			} else {
				showAlertFailed(data.message);
			}
		});
	}
	
	function processRemove(id){
		console.log('processRemove '+id)
		var removeData = {
			idKey : id
		}
		restPOST('POST', '/gui-re-broker/marketing/renewal/remove', removeData).done(function(data) {
			idRemove = null;
			$('#modalConfirmationDelete').modal('hide');
			if (data.status == "200") {
				showAlertSuccess();
			} else {
				showAlertFailed(data.message);
			}
		});
	}
	
	
	function send(idKey){
		
		$('#loadingModal').modal('show');
		var dataSend = {
				idKey : idKey
		}
		restPOST('POST', '/gui-re-broker/marketing/renewal/send', dataSend).done(function(data) {
			
			setTimeout(function () {
		       	console.log('completed');
		       	$('#loadingModal').modal('hide');
		    }, 0);
			if (data.status == "200") {
				showAlertSuccess();
			} else {
				showAlertFailed(data.message);
			}
		});
	}

	
	function exportTable(){
		var typeOfCover = $('#typeOfCover').val();
		var expiryDate = $('#expiryDate').val();
		var to = $('#to').val();
		var client = $('#clientDesc').val();
		var status = $('#status').val();
		
		var param = "";
		param = param+"typeOfCover="+typeOfCover;
		param = param+"&expiryDate="+expiryDate;
		param = param+"&to="+to;
		param = param+"&client="+client;
		param = param+"&status="+status;
		
		param = encodeURI(param);
		var url = '/gui-re-broker/marketing/renewal/export?';
		window.open(url+param, '_blank');
	}
	
	function print(){
		var typeOfCover = $('#typeOfCover').val();
		var expiryDate = $('#expiryDate').val();
		var to = $('#to').val();
		var client = $('#clientDesc').val();
		var status = $('#status').val();
		
		var param = "";
		param = param+"typeOfCover="+typeOfCover;
		param = param+"&expiryDate="+expiryDate;
		param = param+"&to="+to;
		param = param+"&client="+client;
		param = param+"&status="+status;
		
		param = encodeURI(param);
		var url = '/gui-re-broker/marketing/renewal/print?';
		window.open(url+param, '_blank');
	}
	
	 
	function showAlertSuccess() {
		$(location).attr('href', '#page-top');
		$('#alertSuccess').fadeTo(2000, 500).slideUp(500, function() {
			$('#alertSuccess').slideUp(500);
			location.reload();
		});
	}
	
	function showAlertSuccessSend() {
		$(location).attr('href', '#page-top');
		$('#alertSuccessSend').fadeTo(2000, 500).slideUp(500, function() {
			$('#alertSuccessSend').slideUp(500);
			location.reload();
		});
	}
	function showAlertSuccessDelete() {
		$(location).attr('href', '#page-top');
		$('#alertSuccessDelete').fadeTo(2000, 500).slideUp(500, function() {
			$('#alertSuccess').slideUp(500);
			location.reload();
		});
	}

	function showAlertFailed(msgAlert) {
		$(location).attr('href', '#page-top');
		$('#alertFailedMsg').text(msgAlert);
		$('#alertFailed').fadeTo(3000, 500).slideUp(500, function() {
			$('#alertFailed').slideUp(500);
			$('#btnModalYesDelete').removeAttr('disabled')
			$('#btnModalYes').removeAttr('disabled')
		});
	}
	/*]]>*/
</script>

</html>